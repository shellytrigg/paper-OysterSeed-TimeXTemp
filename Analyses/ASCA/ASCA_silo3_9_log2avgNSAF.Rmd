---
title: "ASCA_avgNSAFvals_allProteins_noDay0"
author: "Shelly Trigg"
date: "9/13/2019"
output: rmarkdown::github_document
---

load libraries
```{r, echo = FALSE}
library(dplyr)
library(tidyr)
library(MetStaT)
library(ggplot2)
library(heatmap3)
library(colorRamps)
library(plotrix)
```

load data
```{r}
#Read in NSAF data (this is Supplementary Data 3)

data <- read.csv("../Technical_Replicates_PCA/silo3and9_nozerovals_NSAF_AVGs.csv", stringsAsFactors = FALSE)

```


```{r subset_data_for_CHOYP_only_rm0, echo = FALSE}
#make a dataframe with just CHOYP proteins and exclude day 0 for data going into ASCA
choyp_data <- data[which(data$dpf !=19),c(1:2,grep("CHOYP", colnames(data)))]
```


**Perform ASCA on log2 data**
```{r}
#create matrix to pass to ASCA command, excluding the silo and time info
ASCA_X <- as.matrix(log(choyp_data[,-c(1:2)],2))
#create matrix to pass to ASCA command with only the silo and time info
ASCA_F <- as.matrix(choyp_data[,c(1:2)])
#perform ASCA
ASCA <- ASCA.Calculate(ASCA_X, ASCA_F, equation.elements = "1,2,12", scaling = FALSE)
```

Here is a summary of the ASCA results (e.g. variance explained by different factors; factor 1= time (dpf), factor 2 = temperature, interaction = interaction of time and temperature)
```{r}
#print the ASCA summary
ASCA.GetSummary(ASCA)
#write results out to a file
capture.output(ASCA.GetSummary(ASCA), file = "ASCA_model_summary.txt")
```

Perform a permutation test on ASCA results to see if experimental effects are significant beyond randomly permuted data
```{r}
set.seed(101)
perm.test <- ASCA.DoPermutationTest(ASCA,perm = 1000)
capture.output(perm.test, file = "ASCA_permTest_summary.txt")
```


### Plot PCAs from ASCA  

**This first plot is the time (dpf) effect PCA**
```{r avgNSAF_PCA_timeEffect_plot}
#plot PCA for factor 1, which is time in this case
time_PC12 <- data.frame(ASCA$`1`$svd$t[,c(1,2)])
time_PC12 <- cbind(data.frame(sort(rep(ASCA$`1`$level.combinations$row.patterns,2))),data.frame(rep(c("23","29"),6)) , time_PC12)
colnames(time_PC12)<- c("dpf","temp","PC1","PC2")
time_PC12$dpf <- factor(time_PC12$dpf)
time_PC12$PC1_j <- jitter(time_PC12$PC1)
time_PC12$PC2_j <- jitter(time_PC12$PC2)

jpeg(file="../../Figures/MainText/Figure3a.jpg", width=7, height=5, units = "in", res = 300)
ggplot(time_PC12, aes(PC1_j, PC2_j)) + geom_point(aes(color = dpf, shape = temp,size = 3, stroke = 1)) + scale_color_manual(values = c("#E6E6E6","#BDBDBD","#969696","#737373","#525252","#252525"))  + scale_shape_manual(values=c(1,2)) + theme(panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),panel.border = element_rect(colour = "black", fill=NA, size=1), text = element_text(size=15)) + xlab(paste("PC1"," (",formatC(ASCA$`1`$svd$var.explained[1] * 100,digits=2,format="f"),"%)", sep = "")) + ylab(paste("PC2"," (",formatC(ASCA$`1`$svd$var.explained[2] * 100,digits=2,format="f"),"%)", sep = ""))
dev.off()
```

**This next plot is the temperature effect PCA**
```{r avgNSAF_PCA_tempEffect_plot}
#plot PCA for factor 2, which is temperature in this case
temp_PC12 <- data.frame(ASCA$`2`$svd$t[,c(1,2)])
temp_PC12 <- cbind(data.frame(sort(rep(ASCA$`1`$level.combinations$row.patterns,2))),data.frame(rep(c("23","29"),6)) , temp_PC12)
colnames(temp_PC12)<- c("dpf","temp","PC1","PC2")
temp_PC12$dpf <- as.factor(temp_PC12$dpf)


temp_PC12$PC1_j <- jitter(temp_PC12$PC1)
temp_PC12$PC2_j <- jitter(temp_PC12$PC2)

jpeg(file="../../Figures/MainText/Figure5a.jpg", width=7, height=5, units = "in", res = 300)
ggplot(temp_PC12, aes(PC1_j, PC2_j)) + geom_point(aes(color = dpf, shape = temp, size = 6, stroke = 2)) + scale_color_manual(values = c("#E6E6E6","#BDBDBD","#969696","#737373","#525252","#252525")) + scale_shape_manual(values=c(1,2)) + theme(panel.grid.major =element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank(),axis.line = element_line(colour = "black"),panel.border = element_rect(colour = "black", fill=NA, size=1), text = element_text(size=15)) + xlab(paste("PC1"," (",formatC(ASCA$`2`$svd$var.explained[1] * 100,digits=2,format="f"),"%)", sep = "")) + ylab(paste("PC2"," (",formatC(ASCA$`2`$svd$var.explained[2] * 100,digits=2,format="f"),"%)", sep = ""))
dev.off()
```


### Analysis of proteins affected by temperature

Because the temperature effect PCA show the most separation between 23C and 29C in PC2, we will look at those loadings.

**PC1 loadings for temperature effect**
```{r avgNSAF_PCA_tempEffect_PC2loadings, echo = FALSE}
#extract protein names from ASCA data; these will be combined with loadings values; the order is maintained
protnames <- data.frame(colnames(ASCA$data))
#combine protein names with ASCA loadings for PC2 for temperature, since this component showed the greatest separation between temperatures
d <- cbind(protnames, ASCA$`2`$svd$v[,1])
#rename the columns
colnames(d) <- c("protein", "PC1loadings")
#make a dataframe of proteins with PC loadings greater than zero for the loadings plot
d_great <- d[which(d$PC1loadings > 0),]
#make a dataframe of proteins with PC loadings less than zero for the loadings plot
d_less <- d[which(d$PC1loadings < 0),]

#write out PC1 loadings for ASCA$2$svd$[,1]
write.csv(d, "ASCA_temperature_PC1_loadings.csv", row.names = FALSE, quote = FALSE)

#plot PC1 loadings
jpeg(file="../../Figures/AdditionalFile1/FigureS2e.jpg", width=10, height=8, units = "in", res = 300)
plot(d_great[order(d_great$PC1loadings, decreasing = TRUE),2], xlab = "protein", ylab = "PC1 Loadings")
abline(h=0.03, col = "red")
dev.off()

jpeg(file="../../Figures/AdditionalFile1/FigureS2f.jpg", width=10, height=8, units = "in", res = 300)
plot(d_less[order(d_less$PC1loadings, decreasing = TRUE),2],xlab = "protein", ylab = "PC1 Loadings")
abline(h=-0.025, col = "red")
dev.off()

```

To pull out proteins affected by temperature based on their influence in seperating treatment groups on PC1 of the temperature PCA, I picked an absolute value loadings threshold of 0.025. This means any protein that had a loadings value > 0.03 or < -0.025 was selected.
```{r, echo = FALSE}
#make list of proteins with temperature PC1 loadings values >= 0.025
cutd <- d[which(d$PC1loadings >= 0.03 | d$PC1loadings <= -0.025),]
#make a list of cutoff proteins with normalized abundance
cut_data <-data[,which(colnames(data) %in% cutd$protein)]
rownames(cut_data) <- paste(data$dpf, data$temp, sep="_")
```


Number of proteins affected by temperature at loadings value > 0.03 or < -0.025
```{r, echo = FALSE}
nrow(cutd)
```



**Heatmap of proteins affected by temperature based on temperature effect PC1 loadings value cutoff**
```{r avgNSAF_tempEffectPC1_cutoff0.03&-0.025_heatmap_OrderedByTemp_ShortNames,fig.height=10, fig.width=10, eval = FALSE, echo = FALSE}
#reorder the cut data so that samples are grouped by temperature
cut_data_ord <- data[,c(1:3,which(colnames(data) %in% cutd$protein))]
cut_data_ord <- cut_data_ord[order(cut_data_ord$temp,cut_data_ord$dpf),]
rownames(cut_data_ord) <- paste(cut_data_ord$dpf, cut_data_ord$temp, sep="_")
cut_data_ord <- cut_data_ord[,-c(1:3)]
#transposed to eventually get row names as columns to match entry names to. 
#t.data.frame returns a matrix so I had convert back to data frame for all downstream rearranging because data frames are much easier to work with
cut_data_ord_t <- data.frame(t.data.frame(cut_data_ord))
#make row names which contain the protein IDs a column
cut_data_ord_t <- cbind(rownames(cut_data_ord_t), cut_data_ord_t)
#add the column name
colnames(cut_data_ord_t)[1] <- "Protein.ID"
#convert the Protein ID column to character
cut_data_ord_t[,1] <- as.character(cut_data_ord_t[,1])
#remove the protein ID column since the row names contain that info
cut_data_ord_t_m <- cut_data_ord_t[,-1]
#this step removes the x from the column names while preserving the order of colnames
colnames(cut_data_ord_t_m) <- rownames(cut_data_ord)
#save proteins as a list
silo3_9_sig_temp_prots <- data.frame(rownames(cut_data_ord_t_m), stringsAsFactors = FALSE)
colnames(silo3_9_sig_temp_prots)[1] <- "prots"

#make data frames to store heatmap color values
#columns are time/temp; color 23C blue, 29C red, each dpf a different shade of gray
ColSideColors<-cbind(temp = c("brown",rep("cyan3",6),rep("magenta2",6)),dpf=c("white",rep(c("#D9D9D9","#BDBDBD","#969696","#737373","#525252","#252525"),2)))

```

**extract clusters from heatmap**
```{r}
hm <- as.dist(1-cor(t.data.frame(cut_data_ord_t_m), use="pa"))
hm2 <- hclust(hm, method = 'complete')
plot(hm2)

#Identify clades in heatmap
# define some clusters

#make a list of proteins with cluster IDs based on where the tree is cut
#1.8 gives 2 clusters
mycl <- cutree(hm2, h=1.8)

#assign colors to cluster IDs
clusterCols <- rev(colorRamps::primary.colors(length(unique(mycl))))
myClusterSideBar <- clusterCols[mycl]

#plot heat map 
jpeg(file="../../Figures/MainText/Figure5b.jpg", width=8, height=8, units = "in", res = 300)
heatmap3(as.matrix(cut_data_ord_t_m),cexRow = 0.5, cexCol = 0.5, RowSideColors=clusterCols[mycl],ColSideColors = ColSideColors,RowAxisColors=1,ColAxisColors=1,hclustfun=hclust, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), method = "complete", scale = "row", Colv=NA,labRow = NA, labCol = NA, RowSideLabs = NA, ColSideLabs = NA)
dev.off()

#get color name
clusterColor <- lapply(myClusterSideBar, color.id)
clusterColor <- lapply(clusterColor, `[[`,1)
clusterColor <- data.frame(unlist(clusterColor), stringsAsFactors = FALSE)

foo <- cbind(data.frame(mycl), clusterColor)
#add protein column to data frame for merging
foo$proteinID <- rownames(foo)

#add protein column back to NSAF data frame for merging
cut_data_ord_t_m_proteinID <- cut_data_ord_t_m
cut_data_ord_t_m_proteinID$proteinID <- rownames(cut_data_ord_t_m)

clade.prot <- merge(foo, cut_data_ord_t_m_proteinID, by = "proteinID")

colnames(clade.prot)[3] <- "ClusterColor"
colnames(clade.prot)[2] <- "ClusterID"

#save temp sig. proteins with NSAF values, protein IDs, cluster color and ID
write.csv(clade.prot,"ASCA_TempProts_avgNSAF.csv", quote = FALSE, row.names = FALSE)


#remove day 0 from clade prot
clade.prot_noD0 <- clade.prot[,-4]

#normalize within terms (autoscale by row)
#calculate row means and SD
clade.prot_noD0$mean <- apply(clade.prot_noD0[,4:15], 1, mean)
clade.prot_noD0$sd <- apply(clade.prot_noD0[,4:15],1, sd)

#sweep second argument is margin which corresponds to 1 (rows) or 2 (columns); this is for autoscaling by row to make colors relative to one another like the heatmap does
#subtract the row mean from each value
clade.prot_no_D0_norm <- sweep(clade.prot_noD0[,4:15],1,clade.prot_noD0$mean)
#divide each value by the row standard deviation
clade.prot_no_D0_norm <- sweep(clade.prot_no_D0_norm[,1:12],1,clade.prot_noD0$sd, FUN = "/")

clade.prot_no_D0_norm <- cbind(clade.prot_noD0[,c("proteinID","ClusterID", "ClusterColor")], clade.prot_no_D0_norm)

#write out autoscaled data
write.csv(clade.prot_no_D0_norm,"ASCA_TempProts_autoscaled_avgNSAF.csv", quote = FALSE, row.names = FALSE)

STACKED_NSAF <- tidyr::gather(clade.prot_no_D0_norm, dpftemp, NSAF, 4:15)
STACKED_NSAF$dpf <- gsub("X|_.*","",STACKED_NSAF$dpftemp)
STACKED_NSAF$temp <- as.factor(gsub(".*_","",STACKED_NSAF$dpftemp))
str(STACKED_NSAF)
STACKED_NSAF$dpf <- as.integer(STACKED_NSAF$dpf)

#make mean summary table for plotting summary lines of protein abundances/clade
STACKED_NSAF_mean <- STACKED_NSAF %>%
    group_by(dpf, temp, ClusterID) %>%
    summarise(n = n(), mean=mean(NSAF), median=median(NSAF), sd=sd(NSAF)) %>%
    mutate(sem = sd / sqrt(n - 1),
      CI_lower = mean + qt((1-0.95)/2, n - 1) * sem,
      CI_upper = mean - qt((1-0.95)/2, n - 1) * sem)

jpeg("../../Figures/MainText/Figure5c.jpg", width=10, height=5, units = "in", res = 300)
ggplot(STACKED_NSAF_mean, aes(x=dpf, y=mean, color = temp)) + geom_line(aes(x=dpf, y=mean, color=temp)) + ylab("mean autoscaled NSAF") + geom_ribbon(aes(ymin=CI_lower,ymax=CI_upper,fill=temp),color="grey70",alpha=0.4)  + facet_wrap(~ClusterID) + scale_color_manual(values=c("cyan3", "magenta2")) + scale_fill_manual(values=c("cyan3", "magenta2")) + scale_x_continuous(breaks = c(21,23,25,27,29,31), labels = c(21,23,25,27,29,31)) + theme_bw() + theme(text = element_text(size=20))
dev.off()

#create simple line plots for showing main trends over time for temp clades
jpeg(file="../../Figures/MainText/Figure6_colLabs.jpg", width=5, height=2, units = "in", res = 300)
ggplot(STACKED_NSAF_mean, aes(x=dpf, y=mean, color = temp)) + geom_line(aes(x=dpf, y=mean, color=temp, size = 1)) + facet_wrap(~ClusterID, ncol = 3) + scale_color_manual(values=c("cyan3", "magenta2")) + scale_x_continuous(breaks = c(21,23,25,27,29,31), labels = c(21,23,25,27,29,31)) + theme_bw() + theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.title.y=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank(),strip.text = element_text(face = "bold",size = 32),strip.background = element_rect(fill="white"))
dev.off()

```



## PART 2
### Analysis of proteins affected by time 

**PC1 loadings for the time effect PCA**
```{r avgNSAF_PCA_timeEffect_PC1loadings, echo = FALSE}
#make dataframes of factor 1 (time) PC1 loadings
d1 <- cbind(protnames, ASCA$`1`$svd$v[,1])
colnames(d1) <- c("protein", "PC1loadings")
d1_great <- d1[which(d1$PC1loadings > 0),]
d1_less <- d1[which(d1$PC1loadings < 0),]

jpeg(file="../../Figures/AdditionalFile1/FigureS2a.jpg", width=10, height=8, units = "in", res = 300)
plot(d1_great[order(d1_great$PC1loadings, decreasing = TRUE),2], ylab = "PC1 Loadings")
abline(h=0.035, col = "red")
dev.off()

jpeg(file="../../Figures/AdditionalFile1/FigureS2b.jpg", width=10, height=8, units = "in", res = 300)
plot(d1_less[order(d1_less$PC1loadings, decreasing = TRUE),2],ylab = "PC1 Loadings")
abline(h=-0.035, col = "red")
dev.off()
```

**PC2 loadings for the time effect PCA**
```{r avgNSAF_PCA_timeEffect_PC2loadings, echo = FALSE}
d2 <- cbind(protnames, ASCA$`1`$svd$v[,2])
colnames(d2) <- c("protein", "PC2loadings")
d2_great <- d2[which(d2$PC2loadings > 0),]
d2_less <- d2[which(d2$PC2loadings < 0),]

jpeg(file="../../Figures/AdditionalFile1/FigureS2c.jpg", width=10, height=8, units = "in", res = 300)
plot(d2_great[order(d2_great$PC2loadings, decreasing = TRUE),2], ylab = "PC2 Loadings")
abline(h=0.035, col = "red")
dev.off()

jpeg(file="../../Figures/AdditionalFile1/FigureS2d.jpg", width=10, height=8, units = "in", res = 300)
plot(d2_less[order(d2_less$PC2loadings, decreasing = TRUE),2], ylab = "PC2 Loadings")
abline(h=-0.035, col = "red")
dev.off()


#make list of proteins with temperature PC1 loadings values >= 0.025
cutd1 <- data.frame(d1[which(abs(d1$PC1loadings) >= 0.035),1])
colnames(cutd1) <- "protein"
cutd2 <- data.frame(d2[which(abs(d2$PC2loadings) >= 0.035),1])
colnames(cutd2) <- "protein"
cutd12 <- unique(rbind(cutd1,cutd2))
```

number of proteins affected by time at loadings value > 0.025 or < -0.025
```{r, echo = FALSE}
nrow(cutd12)
```

write out time affected proteins loadings values
```{r}
#write out PC1 and PC2 loadings for ASCA$1$svd$[,1:2]
d12 <- cbind(protnames, ASCA$`1`$svd$v[,1:2])
colnames(d12) <- c("protein", "PC1loadings", "PC2loadings")
write.csv(d12, "ASCA_time_PC1andPC2_loadings.csv", row.names = FALSE, quote = FALSE)
```

**heatmap of proteins affected by time based on time effect PC1 and PC2 loadings value cutoffs**
```{r avgNSAF_timeEffectPC1and2_cutoff0.025_heatmap_OrderedByTime, echo = FALSE, fig.height=10, fig.width=10, echo = FALSE}
#make a list of cutoff proteins with normalized abundance
cut12_data <-data[,which(colnames(data) %in% cutd12$protein)]
rownames(cut12_data) <- paste(data$dpf, data$temp, sep="_")

#make data frames to store heatmap color values
#columns are dpf/temp; color 23C blue, 29C red, each dpf a different shade of gray
ColSideColors<-cbind(Temp=c("brown",rep(c("cyan3","magenta2"),6)), dpf=c("white",rep("#D9D9D9",2),rep("#BDBDBD",2),rep("#969696",2),rep("#737373",2),rep("#525252",2),rep("#252525",2)))

hm <- as.dist(1-cor(cut12_data, use="pa"))
hm2 <- hclust(hm, method = 'complete')
plot(hm2)

#Identify clades in heatmap
# define some clusters

#make a list of proteins with cluster IDs based on where the tree is cut
mycl <- cutree(hm2, h=1.5)

#assign colors to cluster IDs
clusterCols <- colorRamps::primary.colors(length(unique(mycl)))
myClusterSideBar <- clusterCols[mycl]


#plot heat map 
jpeg(file="../../Figures/MainText/Figure3b.jpg", width=8, height=8, units = "in", res = 300)

heatmap3(t.data.frame(cut12_data),cexRow = 0.5, cexCol = 0.5, RowSideColors=myClusterSideBar,ColSideColors = ColSideColors,RowAxisColors=1,ColAxisColors=1,hclustfun=hclust, distfun = function(x) as.dist(1 - cor(t(x), use = "pa")), method = "complete", scale = "row", Colv=NA,labRow = NA, labCol = NA, RowSideLabs = NA, ColSideLabs = NA)
dev.off()

#get color name
clusterColor <- lapply(myClusterSideBar, color.id)
clusterColor <- lapply(clusterColor, `[[`,1)
clusterColor <- data.frame(unlist(clusterColor), stringsAsFactors = FALSE)

foo <- cbind(data.frame(mycl), clusterColor)
#add protein column to data frame for merging
foo$protein_ID <- rownames(foo)

#add protein column back to NSAF data frame for merging
cut12_data_proteinID <- data.frame(t(cut12_data))
cut12_data_proteinID$protein_ID <- rownames(cut12_data_proteinID)

clade.prot <- merge(foo,cut12_data_proteinID,  by = "protein_ID")

colnames(clade.prot)[3] <- "ClusterColor"
colnames(clade.prot)[2] <- "ClusterID"

#save time sig. proteins with NSAF values, protein IDs, cluster color and ID
write.csv(clade.prot,"ASCA_TimeProts_avgNSAF.csv", quote = FALSE, row.names = FALSE)


#remove day 0 from clade prot
clade.prot_noD0 <- clade.prot[,-4]

#normalize within terms (autoscale by row)
#calculate row means and SD
clade.prot_noD0$mean <- apply(clade.prot_noD0[,4:15], 1, mean)
clade.prot_noD0$sd <- apply(clade.prot_noD0[,4:15],1, sd)

#sweep second argument is margin which corresponds to 1 (rows) or 2 (columns); this is for autoscaling by row to make colors relative to one another like the heatmap does
#subtract the row mean from each value
clade.prot_no_D0_norm <- sweep(clade.prot_noD0[,4:15],1,clade.prot_noD0$mean)
#divide each value by the row standard deviation
clade.prot_no_D0_norm <- sweep(clade.prot_no_D0_norm[,1:12],1,clade.prot_noD0$sd, FUN = "/")

clade.prot_no_D0_norm <- cbind(clade.prot_noD0[,c("protein_ID", "ClusterID", "ClusterColor")], clade.prot_no_D0_norm)

write.csv(clade.prot_no_D0_norm,"ASCA_TimeProts_autoscaled_avgNSAF.csv", quote = FALSE, row.names = FALSE)

STACKED_NSAF <- tidyr::gather(clade.prot_no_D0_norm, dpftemp, NSAF, 4:15)
STACKED_NSAF$dpf <- gsub("X|_.*","",STACKED_NSAF$dpftemp)
STACKED_NSAF$temp <- as.factor(gsub(".*_","",STACKED_NSAF$dpftemp))
str(STACKED_NSAF)
STACKED_NSAF$dpf <- as.integer(STACKED_NSAF$dpf)

#make mean summary table for plotting summary lines of protein abundances/clade
STACKED_NSAF_mean <- STACKED_NSAF %>%
    group_by(dpf, temp, ClusterID) %>%
    summarise(n = n(), mean=mean(NSAF), median=median(NSAF), sd=sd(NSAF)) %>%
    mutate(sem = sd / sqrt(n - 1),
      CI_lower = mean + qt((1-0.95)/2, n - 1) * sem,
      CI_upper = mean - qt((1-0.95)/2, n - 1) * sem)

jpeg(file="../../Figures/MainText/Figure3c.jpg", width=10, height=5, units = "in", res = 300)
ggplot(STACKED_NSAF_mean, aes(x=dpf, y=mean, color = temp)) +
  geom_line(aes(x=dpf, y=mean, color=temp)) + xlab("dpf") + ylab(" autoscaled NSAF values") +
  geom_ribbon(aes(ymin=CI_lower,ymax=CI_upper,fill=temp),color="grey70",alpha=0.4)  + facet_wrap(~ClusterID, ncol = 3) + scale_color_manual(values=c("cyan3", "magenta2")) + scale_fill_manual(values=c("cyan3", "magenta2")) + scale_x_continuous(breaks = c(21,23,25,27,29,31), labels = c(21,23,25,27,29,31)) + theme_bw() + theme(text = element_text(size=20))
dev.off()

#create a simple plot for common trend over time 
STACKED_NSAF_mean_dpf <- STACKED_NSAF %>%
    group_by(dpf, ClusterID) %>%
    summarise(n = n(), mean=mean(NSAF), median=median(NSAF), sd=sd(NSAF)) %>%
    mutate(sem = sd / sqrt(n - 1),
      CI_lower = mean + qt((1-0.95)/2, n - 1) * sem,
      CI_upper = mean - qt((1-0.95)/2, n - 1) * sem)

jpeg("../../Figures/MainText/Figure4_colLabs.jpg", width = 5, height = 1, units = "in", res =300)
ggplot(STACKED_NSAF_mean_dpf, aes(x=dpf, y=mean)) + geom_line(aes(x=dpf, y=mean), size = 1) +ylab("mean autoscaled NSAF") + facet_wrap(~ClusterID, ncol = 5)  + scale_x_continuous(breaks = c(21,23,25,27,29,31), labels = c(21,23,25,27,29,31)) + theme_bw()+ theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(),axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank(),axis.title.y=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank(),strip.text = element_text(face = "bold",size = 15),strip.background = element_rect(fill="white"))
dev.off()
```



